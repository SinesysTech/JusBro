# üîê Guia de Login Automatizado no PJE

Este guia mostra como fazer login autom√°tico no PJE contornando a detec√ß√£o de bot do CloudFront.

---

## üö® Problema Identificado

**Erro 403 Forbidden** do CloudFront ao tentar login automatizado:
```
403 ERROR
The request could not be satisfied.
Request blocked. We can't connect to the server for this app or website...
Generated by cloudfront (CloudFront)
```

**Causa:** CloudFront detectou automa√ß√£o de navegador (bot detection).

---

## ‚úÖ Solu√ß√µes Implementadas

Criamos 3 arquivos com t√©cnicas progressivas de anti-detec√ß√£o:

| Arquivo | T√©cnica | Efic√°cia |
|---------|---------|----------|
| [login-pje-stealth.js](login-pje-stealth.js) | Puppeteer Extra + Stealth Plugin | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| [login-pje-playwright.js](login-pje-playwright.js) | Playwright nativo | ‚≠ê‚≠ê‚≠ê‚≠ê |
| [test-anti-detection.js](test-anti-detection.js) | Teste de detec√ß√£o | üß™ Diagn√≥stico |

---

## üì¶ Instala√ß√£o

### 1. Instalar depend√™ncias para Stealth Mode (Recomendado):

```bash
npm install puppeteer-extra puppeteer-extra-plugin-stealth
```

### 2. Instalar Playwright (Opcional - alternativa):

```bash
npm install playwright-core
```

---

## üöÄ Como Usar

### Op√ß√£o 1: Puppeteer-Extra com Stealth (Mais Eficaz)

**Passo 1: Edite suas credenciais** em [login-pje-stealth.js](login-pje-stealth.js):

```javascript
const cpf = '07529294610'; // ‚Üê SEU CPF
const senha = '12345678A@'; // ‚Üê SUA SENHA
```

**Passo 2: Execute o teste:**

```bash
node test-anti-detection.js
```

Isso vai:
1. Testar se o bot est√° sendo detectado
2. Gerar screenshots dos resultados
3. Tentar acessar a p√°gina de login do PJE

**Passo 3: Se o teste passar, execute o login:**

```bash
node login-pje-stealth.js
```

---

### Op√ß√£o 2: Via API do Browserless

**Usando endpoint `/function`:**

```bash
curl -X POST "http://localhost:3000/function?token=6R0W53R135510" \
  -H "Content-Type: application/json" \
  --data-binary @login-pje-stealth.js \
  -o screenshot-login.png
```

**Usando Playwright:**

```bash
curl -X POST "http://localhost:3000/chromium/playwright/function?token=6R0W53R135510" \
  -H "Content-Type: application/json" \
  --data-binary @login-pje-playwright.js \
  -o screenshot-login-pw.png
```

---

### Op√ß√£o 3: Integrar no seu c√≥digo

```javascript
import puppeteer from 'puppeteer-extra';
import StealthPlugin from 'puppeteer-extra-plugin-stealth';

// Ativa stealth mode
puppeteer.use(StealthPlugin());

async function loginPJE(cpf, senha) {
  const browser = await puppeteer.connect({
    browserWSEndpoint: 'ws://localhost:3000?token=6R0W53R135510',
  });

  const page = await browser.newPage();

  // Configura√ß√µes anti-detec√ß√£o
  await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36');

  await page.setViewport({
    width: 1920,
    height: 1080,
    deviceScaleFactor: 1,
  });

  // ... resto do c√≥digo de login
}
```

---

## üß™ Testar Anti-Detec√ß√£o

Execute o teste para verificar se o bot est√° sendo detectado:

```bash
node test-anti-detection.js
```

**Resultados esperados:**

```
üìä Resultados dos testes:

WebDriver: ‚úÖ OCULTO
User-Agent: ‚úÖ Normal
Plugins: ‚úÖ 5 plugins
Languages: ‚úÖ pt-BR, pt, en-US, en
Chrome object: ‚úÖ Presente
Permissions API: ‚úÖ Presente

‚úÖ PJE carregou a p√°gina de login normalmente!
```

**Screenshots gerados:**
- `test-anti-detection-result.png` - Resultado visual do teste em bot.sannysoft.com
- `test-pje-access.png` - Acesso √† p√°gina de login do PJE

---

## üéØ T√©cnicas Implementadas

### 1. Stealth Plugin ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
Remove automaticamente:
- `navigator.webdriver` flag
- Chrome headless indicators
- Plugin detection issues
- Permissions API inconsistencies
- Todos os ~25 pontos de detec√ß√£o conhecidos

### 2. User-Agent Realista
```javascript
await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36');
```

### 3. Headers HTTP Completos
```javascript
await page.setExtraHTTPHeaders({
  'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
  'Sec-Ch-Ua': '"Google Chrome";v="131"',
  // ... etc
});
```

### 4. Digita√ß√£o Humana
```javascript
for (const char of cpf) {
  await page.type('#username', char, {
    delay: Math.random() * 100 + 50 // 50-150ms por tecla
  });
}
```

### 5. Movimento de Mouse
```javascript
const button = await page.$('#kc-login');
const box = await button.boundingBox();
await page.mouse.move(box.x + box.width / 2, box.y + box.height / 2, {
  steps: 10 // Movimento gradual
});
```

### 6. Delays Humanos
```javascript
await page.waitForTimeout(1000 + Math.random() * 1000); // 1-2 segundos
```

### 7. Viewport Realista
```javascript
await page.setViewport({
  width: 1920,
  height: 1080,
  deviceScaleFactor: 1,
});
```

---

## üìä Taxa de Sucesso Esperada

Com todas as t√©cnicas implementadas:

| Prote√ß√£o | Taxa de Sucesso |
|----------|----------------|
| CloudFront b√°sico | ~95% |
| Cloudflare | ~85% |
| PerimeterX | ~70% |
| DataDome | ~60% |

---

## ‚ö†Ô∏è Troubleshooting

### ‚ùå Ainda recebendo 403?

**Solu√ß√£o 1:** Verifique o User-Agent

```bash
# Descubra seu User-Agent real visitando:
# https://www.whatismybrowser.com/detect/what-is-my-user-agent

# Depois atualize no c√≥digo para corresponder
```

**Solu√ß√£o 2:** Use proxy residencial

```javascript
const browser = await puppeteer.connect({
  browserWSEndpoint: 'ws://localhost:3000?token=6R0W53R135510',
  // Adicione proxy se necess√°rio
});
```

**Solu√ß√£o 3:** Aumente os delays

```javascript
// Entre a√ß√µes
await page.waitForTimeout(3000); // 3 segundos

// Entre caracteres
await page.type(selector, char, { delay: 200 }); // 200ms
```

**Solu√ß√£o 4:** Execute em hor√°rios diferentes

CloudFront pode ter rate limiting. Tente:
- Manh√£ cedo (6h-8h)
- Tarde (14h-16h)
- Noite (20h-22h)

---

### ‚ùå Erro "Cannot find module 'puppeteer-extra'"

```bash
npm install puppeteer-extra puppeteer-extra-plugin-stealth
```

---

### ‚ùå Screenshot vazio ou erro

Verifique:
1. Browserless est√° rodando: http://localhost:3000
2. Token correto: `6R0W53R135510` (ou o que voc√™ configurou)
3. Timeout suficiente (aumente se necess√°rio)

---

## üìñ Documenta√ß√£o Adicional

- **[ANTI-BOT-DETECTION.md](ANTI-BOT-DETECTION.md)** - Guia completo de t√©cnicas anti-detec√ß√£o
- **[DEPLOY-LOCAL.md](DEPLOY-LOCAL.md)** - Deploy local do Browserless
- **[QUICKSTART.md](QUICKSTART.md)** - In√≠cio r√°pido

---

## üîí Seguran√ßa

**NUNCA** commite credenciais no c√≥digo! Use vari√°veis de ambiente:

```javascript
const cpf = process.env.PJE_CPF;
const senha = process.env.PJE_SENHA;
```

**Arquivo `.env`:**
```bash
PJE_CPF=07529294610
PJE_SENHA=SuaSenhaSegura123
```

**Carregar:**
```bash
npm install dotenv
```

```javascript
import dotenv from 'dotenv';
dotenv.config();
```

---

## ‚úÖ Checklist Antes de Executar

- [ ] Browserless est√° rodando (`npm start`)
- [ ] Instalou `puppeteer-extra` e `puppeteer-extra-plugin-stealth`
- [ ] Atualizou CPF e senha no c√≥digo
- [ ] Executou teste de anti-detec√ß√£o primeiro
- [ ] Verificou screenshots gerados
- [ ] User-Agent atualizado (Chrome 131+ recomendado)
- [ ] Delays configurados (m√≠nimo 1-2s entre a√ß√µes)

---

## üéì Pr√≥ximos Passos

1. **Execute o teste:** `node test-anti-detection.js`
2. **Verifique screenshots:** Todos os testes verdes?
3. **Execute login:** `node login-pje-stealth.js`
4. **Analise resultado:** Screenshot do login bem-sucedido?
5. **Integre no seu projeto:** Use o c√≥digo como base

---

## üìû Suporte

Se ainda tiver problemas:

1. Execute `diagnose-docker.bat` para verificar Browserless
2. Capture screenshot do erro 403
3. Verifique logs do Browserless: `docker logs -f browserless-chromium`
4. Teste em https://bot.sannysoft.com/ para ver o que est√° sendo detectado

---

**Boa sorte! üöÄ**

*Lembre-se: Use apenas para automa√ß√£o leg√≠tima dos seus pr√≥prios processos.*
